### What is the UDS protocol?

Unified Diagnostic Services (UDS) is a communication protocol used in automotive Electronic Control Units (ECUs) to enable diagnostics, firmware updates, routine testing and more.

The UDS protocol (ISO 14229) is standardized across both manufacturers and standards (such as CAN, KWP 2000, Ethernet, LIN).

>This means, no matter the vehicle manufacturer or the communication protocol used by the vehicle, UDS has the capability to connect and communicate with the said vehicle.

In turn, this enables various use cases:

- Read/clear diagnostic trouble codes (DTC) for troubleshooting vehicle issues.
- Extract parameter data values such as temperatures, state of charge, VIN etc.
- Initiate diagnostic sessions, e.g. to test safety-critical features.
- Modify ECU behavior via resets, firmware flashing and settings modification.

UDS is sometimes referred to as 'vehicle manufacturer enhanced diagnostics' or 'enhanced diagnostics'.


## UDS message structure

UDS is a request-based protocol. In the illustration below, we have an example of a UDS request frame (using CAN bus as a basis):

https://do7js0tdxrds1.cloudfront.net/gn853wwr28qt2jpdm972c6kyda19?response-content-disposition=inline%3B+filename%3D%22UDS+packet.png%22%3B&response-content-type=image%2Fpng&Expires=1701171508&Signature=FH-SZZ4cKPke5f1XfCTbnhlXvfNMrb27DtPNtz-tkYDyRyxS-kks5P9tgwAkJUrqUgyA3P7AWDIpmwWQuSaeIXMeW9yhq8iV4o8-BtnI2N9o8eaEIbcITFuPwXU5d5Llt88iRLri2qMOJgJH9bvqh6eNMdILvAAyHxVHi2Pg7dtlpOvjDvtvep~7twezMuTFS7l6vBrGef4IC7e7VcsB-1iWjTNAAf8uv1rQr-eFJfy7QVl081y4r3fJ4Bb3Fw-gjdpcDY6TBko2c3VCk2nwuKwpj9aj4L8YW9NCKwvCOB9USxCTv1nhPlhbRRBE3IG1nhVhDyusOXQae7jtuNCDLw__&Key-Pair-Id=K2Q3HDJ6ZAQGFF

A diagnostic UDS request on CAN contain various fields, explained below,

#### 1. Protocol Control Information (PCI)
The PCI field is not per se related to the UDS request itself, but is required for diagnostic UDS requests made on the CAN bus.

In short, the PCI field can be 1-3 bytes long and contains information related to the transmission of messages that do not fit within a single CAN frame.

#### 2. UDS Service ID (SID)

The use cases outlined below relate to different UDS services. 

When you wish to utilize a specific UDS service, the UDS request message should contain the UDS Service Identifier (SID) in the data payload. 

>Note that the identifiers are split between request SIDs (e.g. 0x22) and response SIDs (e.g. 0x62).

| Request   SID | Response   SID |               Service              |                                                                                                                                                                                                                                                                                                                                                                                Description                                                                                                                                                                                                                                                                                                                                                                               |
|:-------------:|:--------------:|:----------------------------------:|:------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
|      0x10     |      0x50      | Diagnostic Session Control         | UDS uses different operating sessions, which can be changed using the "Diagnostic Session Control". Depending on which session is active, different services are available. On start, the control unit is by default in the "Default Session". Other sessions are defined, but are not required to be implemented depending on the type of device: "Programming Session" used to upload software. "Extended Diagnostic Session" used to unlock additional diagnostic functions, such as the adjustment of sensors. "Safety system diagnostic session" used to test all safety-critical diagnostic functions, such as airbag tests. In addition, there are reserved session identifiers that can be defined for vehicle manufacturers and vehicle suppliers specific use. |
|      0x11     |      0x51      | ECU Reset                          | The service "ECU reset" is used to restart the control unit (ECU). Depending on the control unit hardware and implementation, different forms of reset can be used: "Hard Reset" simulates a shutdown of the power supply. "Key off on Reset" simulates the drain and turn on the ignition with the key. "Soft Reset" allows the initialization of certain program units and their storage structures. Again, there are reserved values that can be defined for vehicle manufacturers and vehicle suppliers specific use.                                                                                                                                                                                                                                                |
|      0x27     |      0x67      | Security Access                    | Security check is available to enable the most security-critical services. For this purpose a "Seed" is generated and sent to the client by the control unit. From this "Seed" the client has to compute a "Key" and send it back to the control unit to unlock the security-critical services.                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|      0x28     |      0x68      | Communication Control              | With this service, both the sending and receiving of messages can be turned off in the control unit.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
|      0x29     |      0x69      | Authentication                     | An update (2020) of the standard added this service to provide a standardized approach to more modern methods of authentication than are permitted by the Security Access (0x27) service, including bidirectional authentication with PKI-based Certificate Exchange.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
|      0x3E     |      0x7E      | Tester Present                     | If no communication is exchanged with the client for a long time, the control unit automatically exits the current session and returns to the "Default Session" back, and might go to sleep mode. Therefore, there is an extra service which purpose is to signal to the device that the client is still present.                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|      0x83     |      0xC3      | Access Timing Parameters           | In the communication between the controllers and the client, certain times must be observed. If these are exceeded, without a message being sent, it must be assumed that the connection was interrupted. These times can be called up and changed.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
|      0x84     |      0xC4      | Secured Data Transmission          |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|      0x85     |      0xC5      | Control DTC Settings               | Enable or disable the detection of any or all errors. This is important when diagnostic work is performed in the car, which can cause an anomalous behavior of individual devices.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|      0x86     |      0xC6      | Response On Event                  |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
|      0x87     |      0xC7      | Link Control                       | The Service Link Control is used to set the baud rate of the diagnostic access.

#### 3. UDS Sub Function Byte

The sub function byte is used in some UDS request frames. 

Generally, when a request is sent to an ECU, the ECU may respond positively or negatively. In case the response is positive, the tester may want to suppress the response (as it may be irrelevant). This is done by setting the 1st bit to 1 in the sub-function byte. Negative responses cannot be suppressed.

#### 4. UDS 'Request Data Parameters' - incl. Data Identifier (DID)

In most UDS request services, various types of request data parameters are used to provide further configuration of a request beyond the SID and optional sub-function byte.

#### 5. Positive vs. negative UDS responses
When an ECU responds positively to a UDS request, the response frame is structured with similar elements as the request frame. 

In some cases, an ECU may provide a negative response to a UDS request - for example, if the service is not supported. A negative response is structured as in the below CAN frame example:

https://do7js0tdxrds1.cloudfront.net/w3erls6l9v4afdfrb09rpe33vzqr?response-content-disposition=inline%3B+filename%3D%22UDS+negative+responce.png%22%3B&response-content-type=image%2Fpng&Expires=1701171508&Signature=AMlVhJc86Dg31Wn0ZVmoOSW0Rdx7gc4qGoq0bYRksPcpk1X1W8Kw90oBoZeD9aGaLj8ffDGby7GQW09tE2XhpTvSpHTVVs48fnT26kEwxF46u82awBU-bya36X3yUN6EKnn7Y0i79qBF7w8-itYSqOPTk58FBOhFMBLIDBoxCPLjxv-vmcsBVnhcUqUQb6maf7n0MKL6TphJLxyqUjoXOYicOvFUBKrmz3cyo5oS468u1nSeBZMX3nqha0ibeHz2O9CaUSwy3ZuzsqG4MrttAlAlCcLhe84Fa-3BFS8VuGtAw88rvdwPLaohNLMVSdv~tTu0Y3z~l4je4Re26sLhaw__&Key-Pair-Id=K2Q3HDJ6ZAQGFF
Caption: UDS negative responce.png

Below we briefly detail the negative response frame with a focus on the negative response code:

- The 1st byte is the PCI field
- The 2nd byte is the Negative Response Code SID, 0x7F
- The 3rd byte is the SID of the rejected request
- The 4th byte is the Negative Response Code (NRC)

In the negative UDS response, the NRC provides information regarding the cause of the rejection as per the table below.

| NRC Code Value |                   NRC Code Name                  |                                                                                                                                                                                                                                                                                              Description                                                                                                                                                                                                                                                                                             |
|:--------------:|:------------------------------------------------:|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------:|
| 0x00           | Positive Response                                | The 0x00 is a special and initiative value that cannot be used for ant NRC. It is this parameter value reserved for several internal code implementation reason.                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 0x10           | General Reject                                   | If there is none of the NRC is available in UDS standard document to meet the needs of the implementation, then you can use this NRC for your ECU.                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 0x11           | Service Not Supported                            | Suppose the client has sent a request with a Service Identifier. That is not supporting in your ECU by your OEM. Even if you can also say as per the requirement or as per the OEM. But the service engineer or client has requested that unknown SID request to the server. Then the server will send the 0x11 NRC response message to the client that it is an unknown Service Identifier.                                                                                                                                                                                                         |
| 0x12           | Sub-function Not Supported                       | Suppose the client has sent a valid and known Service identifier. However the Sub-function Identifier is unknown or invalid. Then the server will send 0x12 Negative Response Code to the client.                                                                                                                                                                                                                                                                                                                                                                                                        |
| 0x13           | Incorrect Message Length Or Invalid Format       | If the client has sent any diagnostic request message whose length or the frame format does not match with the prescribed length or the format for that specified service (SID), then the server will send this NRC.                                                                                                                                                                                                                                                                                                                                                                                 |
| 0x14           | Response Too Long                                | If the client has sent a diagnostic request and the response message length is more than the Transport protocol maximum length, then the server will send this NRC. The CAN-TP has 4096 bytes has a maximum length, if the server sends more than that, then this NRC will be sent by the server to the client. Ex: suppose you requested more number of DIDs at a time to read the data if it will cross that limit, then this NRC will get generated by the server.                                                                                                                            |
| 0x21           | Busy Repeat Request                              | If the server is too busy with some other operation, or you can say any other client request in a multi-client environment, then the server will send this NRC to the client. This NRC is supported by each SID. Ex: Suppose there are two clients connected to your vehicle simultaneously. One client has already requested a service that is under process means incomplete, and the second client is requesting another request to the server, then the server will send the NRC 0x21 to the second server to wait for some time. This time will be defined in the document that you need to check. |
| 0x22           | Conditions Not Correct                           | Before proceeding any service from the client, the server will check for prerequisite conditions are met or not. If not, then the server will send this NRC. Ex: you can say the ECU operational low threshold or high threshold voltage, temperature, etc.                                                                                                                                                                                                                                                                                                                                           |
| 0x24           | Request Sequence Error                           | If the client will send the diagnostic message non-sequentially, then the server will send this NRC to the client. Ex: Suppose in security access SID, the client sent security key first and then seed request, then the server will send this NRC. Because in this 0x27 service, the client should send the seed request first and then the security key.                                                                                                                                                                                                                                          |
| 0x25           | No Response From Sub-net Component               | Suppose the diagnostic request service sent by the client to the server, but the received ECU is not the target ECU, and it is a gateway. So that the Gateway ECU will send this request to the target ECU and that should perform the operation and send back the response message to the Gateway ECU, and then it will send the response message. If the Gateway ECU does not receive the response message from that target ECU or server, then the Gateway ECU will send this NRC to the client. This NRC supported by each SID.                                                                    |
| 0x26           | Failure Prevents Execution Of Requested Action   | If the client requested service and at that time a fault occurred in server ECU after receiving of this ECU so that at least one DTC status bit for TestFailed, Pending, Confirmed or TestFailedSinceLastClear set to 1, then the server will send this NRC to the client. Basically, this failure condition prevents the server from performing the requested action so that the server will not be able to execute the client request.                                                                                                                                                                 |
| 0x31           | Request Out Of Range                             | If the server received a client request with a parameter (DID, RID) that is out of range, then the server will send this NRC. Suppose in your ECU, the DID or RID having some range used and the client requesting it which is not supported in your ECU or might not be supported in this active session, it will send this NRC.                                                                                                                                                                                                                                                                    |
| 0x37           | Required Time Delay Not Expired                  | Once the client will send a wrong security key, client should wait the defined time, and then it should send the key again. But if the client sends the security key before that, then the server will send this NRC.                                                                                                                                                                                                                                                                                                                                                                             |
| 0x38 – 0x4F    | Reserved By Extended Data Link Security Document | This is reserved for future implementation of security layer related NRC

UDS refers to numerous standards/concepts, meaning it can be a bit overwhelming.

So for our course, all you need to know are the above codes and their meanings to communicate with the vehicle you are modifying or building.